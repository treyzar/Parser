import uuid
import re
from django.db import models
from django.utils import timezone


class Template(models.Model):
    TEMPLATE_TYPE_CHOICES = [
        ('HTML', 'HTML'),
        ('DOCX', 'DOCX'),
    ]
    VISIBILITY_CHOICES = [
        ('PUBLIC', 'Public'),
        ('RESTRICTED', 'Restricted'),
    ]

    title = models.CharField(max_length=255)
    description = models.TextField(blank=True, default='')
    template_type = models.CharField(max_length=10, choices=TEMPLATE_TYPE_CHOICES)
    visibility = models.CharField(max_length=20, choices=VISIBILITY_CHOICES, default='PUBLIC')
    owner_id = models.IntegerField(default=1)
    allowed_users = models.JSONField(default=list, blank=True)
    html_content = models.TextField(blank=True, default='')
    docx_file = models.FileField(upload_to='docx_templates/', blank=True, null=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def get_placeholders(self):
        if self.template_type == 'HTML':
            pattern = r'\{\{\s*(\w+)\s*\}\}'
            return list(set(re.findall(pattern, self.html_content)))
        elif self.template_type == 'DOCX' and self.docx_file:
            from docx import Document
            try:
                doc = Document(self.docx_file.path)
                text = '\n'.join([p.text for p in doc.paragraphs])
                for table in doc.tables:
                    for row in table.rows:
                        for cell in row.cells:
                            text += '\n' + cell.text
                pattern = r'\{\{\s*(\w+)\s*\}\}'
                return list(set(re.findall(pattern, text)))
            except Exception:
                return []
        return []

    def is_accessible_by(self, user_id):
        if self.visibility == 'PUBLIC':
            return True
        if self.owner_id == user_id:
            return True
        if user_id in self.allowed_users:
            return True
        return False

    def __str__(self):
        return self.title


class TemplateVersion(models.Model):
    template = models.ForeignKey(Template, on_delete=models.CASCADE, related_name='versions')
    version_number = models.IntegerField()
    html_content = models.TextField(blank=True, default='')
    docx_file = models.FileField(upload_to='docx_versions/', blank=True, null=True)
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        ordering = ['-version_number']
        unique_together = ['template', 'version_number']

    def __str__(self):
        return f"{self.template.title} v{self.version_number}"


class ShareLink(models.Model):
    template = models.ForeignKey(Template, on_delete=models.CASCADE, related_name='share_links')
    token = models.CharField(max_length=64, unique=True, default=uuid.uuid4)
    ttl_days = models.IntegerField(default=7)
    max_uses = models.IntegerField(default=50)
    current_uses = models.IntegerField(default=0)
    created_at = models.DateTimeField(auto_now_add=True)

    def is_valid(self):
        if self.current_uses >= self.max_uses:
            return False
        expiry = self.created_at + timezone.timedelta(days=self.ttl_days)
        if timezone.now() > expiry:
            return False
        return True

    def increment_use(self):
        self.current_uses += 1
        self.save()

    def __str__(self):
        return f"ShareLink for {self.template.title}"
